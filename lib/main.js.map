{
  "version": 3,
  "file": "",
  "sourceRoot": "",
  "sources": [
    "../src/main.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "\n'use strict'\n\n\n############################################################################################################\nCND                       = require 'cnd'\nrpr                       = CND.rpr\nbadge                     = 'ICQL-DBA-TAGS'\ndebug                     = CND.get_logger 'debug',     badge\nwarn                      = CND.get_logger 'warn',      badge\ninfo                      = CND.get_logger 'info',      badge\nurge                      = CND.get_logger 'urge',      badge\nhelp                      = CND.get_logger 'help',      badge\nwhisper                   = CND.get_logger 'whisper',   badge\necho                      = CND.echo.bind CND\n#...........................................................................................................\ntypes                     = new ( require 'intertype' ).Intertype\n{ isa\n  type_of\n  validate\n  validate_list_of }      = types.export()\n# { to_width }              = require 'to-width'\nSQL                       = String.raw\n{ lets\n  freeze }                = require 'letsfreezethat'\nE                         = require './errors'\n{ Dba, }                  = require 'icql-dba'\n\n\n#===========================================================================================================\ntypes.declare 'dbatags_constructor_cfg', tests:\n  '@isa.object x':        ( x ) -> @isa.object x\n  'x.prefix is a prefix': ( x ) ->\n    return false unless @isa.text x.prefix\n    return true if x.prefix is ''\n    return ( /^[_a-z][_a-z0-9]*$/ ).test x.prefix\n  \"x.fallbacks in [ true, false, 'all', ]\": ( x ) -> x.fallbacks in [ true, false, 'all', ]\n  \"@isa.integer x.first_id\":  ( x ) -> @isa.integer x.first_id\n  \"@isa.integer x.last_id\":   ( x ) -> @isa.integer x.last_id\n\n#-----------------------------------------------------------------------------------------------------------\ntypes.declare 'dbatags_tag', tests:\n  '@isa.nonempty_text x':       ( x ) -> @isa.nonempty_text x\n\n#-----------------------------------------------------------------------------------------------------------\ntypes.declare 'dbatags_mode', tests:\n  \"x in [ '+', '-', ]\":         ( x ) -> x in [ '+', '-', ]\n\n#-----------------------------------------------------------------------------------------------------------\ntypes.declare 'dbatags_add_tag_cfg', tests:\n  '@isa.object x':              ( x ) -> @isa.object x\n  '@isa.dbatags_tag x.tag':     ( x ) -> @isa.dbatags_tag x.tag\n  '@isa.dbatags_mode x.mode':   ( x ) -> @isa.dbatags_mode x.mode\n  'not x.nr?':                  ( x ) -> not x.nr?\n\n#-----------------------------------------------------------------------------------------------------------\ntypes.declare 'dbatags_add_tagged_range_cfg', tests:\n  '@isa.object x':              ( x ) -> @isa.object x\n  '@isa.integer x.lo':          ( x ) -> @isa.integer x.lo ### TAINT add boundary check ###\n  '@isa.integer x.hi':          ( x ) -> @isa.integer x.hi ### TAINT add boundary check ###\n  '@isa.dbatags_tag x.tag':     ( x ) -> @isa.dbatags_tag x.tag\n\n#-----------------------------------------------------------------------------------------------------------\ntypes.declare 'dbatags_tagchain_from_id_cfg', tests:\n  '@isa.object x':              ( x ) -> @isa.object x\n  '@isa.integer x.id':          ( x ) -> @isa.integer x.id ### TAINT add boundary check ###\n\n#-----------------------------------------------------------------------------------------------------------\ntypes.declare 'dbatags_tags_from_id_cfg', tests:\n  '@isa.object x':              ( x ) -> @isa.object x\n  '@isa.integer x.id':          ( x ) -> @isa.integer x.id ### TAINT add boundary check ###\n\n#-----------------------------------------------------------------------------------------------------------\ntypes.declare 'dbatags_parse_tagex_cfg', tests:\n  '@isa.object x':              ( x ) -> @isa.object x\n  '@isa.nonempty_text x.tagex': ( x ) -> @isa.nonempty_text x.tagex\n\n#-----------------------------------------------------------------------------------------------------------\ntypes.declare 'dbatags_tags_from_tagchain_cfg', tests:\n  '@isa.object x':              ( x ) -> @isa.object x\n  '@isa.list x.tagchain':       ( x ) -> @isa.list x.tagchain\n\n#-----------------------------------------------------------------------------------------------------------\ntypes.declare 'dbatags_tags_from_tagexchain_cfg', tests:\n  '@isa.object x':              ( x ) -> @isa.object x\n\n#-----------------------------------------------------------------------------------------------------------\ntypes.defaults =\n  dbatags_constructor_cfg:\n    dba:        null\n    prefix:     't_'\n    fallbacks:  false\n    first_id:   0x000000\n    last_id:    0x10ffff\n  dbatags_add_tag_cfg:\n    nr:         null\n    mode:       '+'\n    tag:        null\n    value:      false\n  dbatags_add_tagged_range_cfg:\n    mode:       '+'\n    tag:        null\n    lo:         null\n    hi:         null\n    value:      null\n  dbatags_parse_tagex_cfg:\n    tagex:      null\n  dbatags_tagchain_from_id_cfg:\n    id:         null\n  dbatags_tags_from_id_cfg:\n    id:         null\n  dbatags_tags_from_tagchain_cfg:\n    tagchain:   null\n  dbatags_tags_from_tagexchain_cfg:\n    tagexchain: null\n\n#===========================================================================================================\nclass @Dtags\n  #---------------------------------------------------------------------------------------------------------\n  constructor: ( cfg ) ->\n    validate.dbatags_constructor_cfg @cfg = { types.defaults.dbatags_constructor_cfg..., cfg..., }\n    #.......................................................................................................\n    if @cfg.dba?\n      @dba  = @cfg.dba\n      delete @cfg.dba\n    else\n      @dba  = new Dba()\n    #.......................................................................................................\n    @cfg            = freeze @cfg\n    @_tag_max_nr    = 0\n    @_cache_filled  = false\n    @_create_db_structure()\n    @_compile_sql()\n    @_create_sql_functions()\n    return undefined\n\n  #---------------------------------------------------------------------------------------------------------\n  _create_db_structure: ->\n    { prefix\n      first_id\n      last_id   } = @cfg\n    @dba.execute SQL\"\"\"\n      create table if not exists #{prefix}tags (\n          nr      integer not null,\n          tag     text    not null primary key,\n          value   json    not null default 'true' );\n      create table if not exists #{prefix}tagged_ranges (\n          nr      integer not null primary key,\n          lo      integer not null,\n          hi      integer not null,\n          mode    boolean not null,\n          tag     text    not null references #{prefix}tags ( tag ),\n          value   json    not null );\n      create index if not exists #{prefix}tags_nr_idx on #{prefix}tags          ( nr );\n      create index if not exists #{prefix}idlohi_idx on  #{prefix}tagged_ranges ( lo, hi );\n      create index if not exists #{prefix}idhi_idx on    #{prefix}tagged_ranges ( hi );\n      create table if not exists #{prefix}contiguous_ranges (\n          lo      integer not null,\n          hi      integer not null,\n          tags    json    not null,\n          primary key ( lo, hi ) );\n      create view #{prefix}_potential_inflection_points as\n        select id from ( select cast( null as integer ) as id where false\n          union select #{first_id}\n          union select #{last_id}\n          union select distinct lo      from t_tagged_ranges\n          union select distinct hi + 1  from t_tagged_ranges )\n        order by id asc;\n      create view #{prefix}tags_and_rangelists as\n        select\n          tags                            as tags,\n          #{prefix}collect_many( lo, hi ) as ranges\n        from #{prefix}contiguous_ranges\n        group by tags\n        order by tags;\n      \"\"\"\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _compile_sql: ->\n    prefix = @cfg.prefix\n    @sql =\n      insert_tag: SQL\"\"\"\n        insert into #{prefix}tags ( nr, tag, value )\n          values ( $nr, $tag, $value );\"\"\"\n          # on conflict ( tag ) do nothing;\"\"\"\n      insert_tagged_range: SQL\"\"\"\n        insert into #{prefix}tagged_ranges ( lo, hi, mode, tag, value )\n          values ( $lo, $hi, $mode, $tag, $value )\"\"\"\n      insert_contiguous_range: SQL\"\"\"\n        insert into #{prefix}contiguous_ranges ( lo, hi, tags )\n          values ( $lo, $hi, $tags )\"\"\"\n      tagchain_from_id: SQL\"\"\"\n        select\n            nr,\n            mode,\n            tag,\n            value\n          from #{prefix}tagged_ranges\n          where $id between lo and hi\n          order by nr asc;\"\"\"\n      cached_tags_from_id: SQL\"\"\"\n        select\n            tags\n          from #{prefix}contiguous_ranges\n          where $id between lo and hi\n          limit 1;\"\"\"\n      get_fallbacks: SQL\"\"\"\n        select * from #{prefix}tags\n          order by nr;\"\"\"\n      potential_inflection_points: SQL\"\"\"\n        select id from #{prefix}_potential_inflection_points;\"\"\"\n      truncate_contiguous_ranges: SQL\"\"\"\n        delete from #{prefix}contiguous_ranges;\"\"\"\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _create_sql_functions: ->\n    prefix = @cfg.prefix\n    # #.......................................................................................................\n    # @dba.create_function\n    #   name:           \"#{prefix}_tags_from_id\",\n    #   deterministic:  true,\n    #   varargs:        false,\n    #   call:           ( id ) =>\n    #     fallbacks = @get_filtered_fallbacks()\n    #     tagchain  = @tagchain_from_id { id, }\n    #     tags      = @tags_from_tagchain { tagchain, }\n    #     return JSON.stringify { fallbacks..., tags..., }\n    #.......................................................................................................\n    ### TAINT put these into separate module like `icql-dba-standard` ###\n    @dba.create_window_function\n      name:           prefix + 'collect'\n      varargs:        false\n      start:          -> []\n      step:           ( total, element ) -> total.push element; total\n      inverse:        ( total, dropped ) -> total.pop(); total\n      result:         ( total ) -> JSON.stringify total\n    #.......................................................................................................\n    @dba.create_window_function\n      name:           prefix + 'collect_many'\n      varargs:        true\n      start:          -> []\n      step:           ( total, elements... ) -> total.push elements; total\n      inverse:        ( total, dropped ) -> total.pop(); total\n      result:         ( total ) -> JSON.stringify total\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  add_tag: ( cfg ) ->\n    validate.dbatags_add_tag_cfg cfg = { types.defaults.dbatags_add_tag_cfg..., cfg..., }\n    cfg.value ?= true\n    cfg.value  = JSON.stringify cfg.value\n    @_tag_max_nr++\n    cfg.nr     = @_tag_max_nr\n    @dba.run @sql.insert_tag, cfg\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _create_minimal_contiguous_ranges: ->\n    pi_ids        = ( row.id for row from @dba.query @sql.potential_inflection_points )\n    last_idx      = pi_ids.length - 1\n    last_id       = pi_ids[ last_idx ]\n    prv_tags      = null\n    ids_and_tags  = []\n    #.......................................................................................................\n    for idx in [ 0 ... pi_ids.length - 1 ]\n      id    = pi_ids[ idx ]\n      tags  = JSON.stringify @_tags_from_id_uncached { id, }\n      continue if tags is prv_tags\n      prv_tags  = tags\n      ids_and_tags.push { id, tags, }\n    ids_and_tags.push { id: last_id, tags: null, }\n    #.......................................................................................................\n    for idx in [ 0 ... ids_and_tags.length - 1 ]\n      entry = ids_and_tags[ idx ]\n      lo    = entry.id\n      hi    = ids_and_tags[ idx + 1 ].id - 1\n      tags  = entry.tags\n      @dba.run @sql.insert_contiguous_range, { lo, hi, tags, }\n    #.......................................................................................................\n    @_cache_filled = true\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _on_add_tagged_range: ->\n    @dba.execute @sql.truncate_contiguous_ranges\n    @_cache_filled = false\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  add_tagged_range: ( cfg ) ->\n    validate.dbatags_add_tagged_range_cfg cfg = { types.defaults.dbatags_add_tagged_range_cfg..., cfg..., }\n    cfg.value ?= if cfg.mode is '+' then true else false\n    cfg.value  = JSON.stringify cfg.value\n    @_on_add_tagged_range()\n    @dba.run @sql.insert_tagged_range, cfg\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  get_filtered_fallbacks: ->\n    return {} if @cfg.fallbacks is false\n    R = @get_fallbacks()\n    return R if @cfg.fallbacks is 'all'\n    for tag, value of R\n      delete R[ tag ] if value is false\n    return R\n\n  #---------------------------------------------------------------------------------------------------------\n  get_fallbacks: ->\n    R = {}\n    for row from @dba.query @sql.get_fallbacks\n      R[ row.tag ] = JSON.parse row.value\n    return R\n\n  #---------------------------------------------------------------------------------------------------------\n  tagchain_from_id: ( cfg ) ->\n    validate.dbatags_tagchain_from_id_cfg cfg = { types.defaults.dbatags_tagchain_from_id_cfg..., cfg..., }\n    R = []\n    for row from @dba.query @sql.tagchain_from_id, cfg\n      row.value = JSON.parse row.value\n      R.push row\n    return R\n\n  #---------------------------------------------------------------------------------------------------------\n  _tags_from_id_uncached: ( cfg ) ->\n    validate.dbatags_tags_from_id_cfg cfg = { types.defaults.dbatags_tags_from_id_cfg..., cfg..., }\n    { id, } = cfg\n    R       = @get_filtered_fallbacks()\n    Object.assign R, @tags_from_tagchain { tagchain: ( @tagchain_from_id cfg ), }\n    return R\n\n  #---------------------------------------------------------------------------------------------------------\n  tags_from_id: ( cfg ) ->\n    @_create_minimal_contiguous_ranges() unless @_cache_filled\n    validate.dbatags_tags_from_id_cfg cfg = { types.defaults.dbatags_tags_from_id_cfg..., cfg..., }\n    return JSON.parse @dba.first_value @dba.query @sql.cached_tags_from_id, cfg\n    return R\n\n  #---------------------------------------------------------------------------------------------------------\n  ### TAINT pattern does not allow for escaped quotes ###\n  tagex_pattern: ///\n    ^\n    (?<mode>  [ - + ] )\n    (?<tag>   [ a-z A-Z _ \\/ \\$ ] [ - a-z A-Z 0-9 _ \\/ \\$ ]* )\n    ( : (?<value> [^ - + ]+ | ' .* ' | \" .* \" ) )?\n    $\n    ///\n\n  #---------------------------------------------------------------------------------------------------------\n  parse_tagex: ( cfg ) ->\n    validate.dbatags_parse_tagex_cfg cfg = { types.defaults.dbatags_parse_tagex_cfg..., cfg..., }\n    { tagex, } = cfg\n    unless ( match = tagex.match @tagex_pattern )?\n      throw new E.Dtags_invalid_tagex '^dtags@777^', tagex\n    { mode, tag, value, }   = match.groups\n    switch mode\n      when '+'\n        value ?= 'true'\n      when '-'\n        if value?\n          throw new E.Dtags_subtractive_value '^dtags@778^', tagex\n        value = 'false'\n    try value = JSON.parse value catch error\n      throw new E.Dtags_illegal_tagex_value_literal '^dtags@779^', tagex, error.message\n    return { mode, tag, value, }\n\n  #---------------------------------------------------------------------------------------------------------\n  tags_from_tagchain: ( cfg ) ->\n    ### TAINT make deletion bahvior configurable ###\n    ### TAINT allow to seed result with fallbacks ###\n    validate.dbatags_tags_from_tagchain_cfg cfg = { types.defaults.dbatags_tags_from_tagchain_cfg..., cfg..., }\n    R             = {}\n    { tagchain, } = cfg\n    return R if tagchain.length is 0\n    for tag in tagchain\n      { mode, tag, value, } = tag\n      switch mode\n        when '+' then R[ tag ] = value\n        when '-' then delete R[ tag ]\n        # when '-' then R[ tag ] = value\n        else throw new E.Dtags_unexpected '^dtags@780^', \"unknown tag mode in #{rpr tag}\"\n    return R\n\n  #---------------------------------------------------------------------------------------------------------\n  tags_from_tagexchain: ( cfg ) ->\n    validate.dbatags_tags_from_tagexchain_cfg cfg = { types.defaults.dbatags_tags_from_tagexchain_cfg..., cfg..., }\n    tagchain = ( ( @parse_tagex { tagex, } ) for tagex in cfg.tagexchain )\n    return @tags_from_tagchain { tagchain, }\n\n\n\n"
  ]
}